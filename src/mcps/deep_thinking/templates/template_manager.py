"""
Template Manager for Deep Thinking Engine
"""

from typing import Dict, List, Optional, Any
from pathlib import Path
import threading
from datetime import datetime
import re


class ConfigurationError(Exception):
    """Configuration error"""
    pass


class TemplateManager:
    """Simple template manager with caching"""
    
    def __init__(self, templates_dir: str = "templates"):
        self.templates_dir = Path(templates_dir)
        self.cache: Dict[str, str] = {}
        self.metadata: Dict[str, Dict[str, Any]] = {}
        self.lock = threading.RLock()
        
        self.templates_dir.mkdir(exist_ok=True)
        self._create_builtin_templates()
    
    def _create_builtin_templates(self):
        """Create built-in templates"""
        templates = {
            "decomposition": """# æ·±åº¦æ€è€ƒï¼šé—®é¢˜åˆ†è§£

ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é—®é¢˜åˆ†æžä¸“å®¶ã€‚è¯·å°†ä»¥ä¸‹å¤æ‚é—®é¢˜åˆ†è§£ä¸ºå¯ç®¡ç†çš„å­é—®é¢˜ï¼š

**ä¸»è¦é—®é¢˜**: {topic}
**å¤æ‚åº¦**: {complexity}
**å…³æ³¨é‡ç‚¹**: {focus}
**é¢†åŸŸèƒŒæ™¯**: {domain_context}

## åˆ†è§£è¦æ±‚ï¼š
1. å°†ä¸»é—®é¢˜åˆ†è§£ä¸º3-7ä¸ªæ ¸å¿ƒå­é—®é¢˜
2. æ¯ä¸ªå­é—®é¢˜åº”è¯¥ç›¸å¯¹ç‹¬ç«‹ä¸”å¯æ·±å…¥åˆ†æž
3. ç¡®ä¿è¦†ç›–é—®é¢˜çš„ä¸åŒè§’åº¦å’Œå±‚é¢
4. è¯†åˆ«å­é—®é¢˜ä¹‹é—´çš„ä¾èµ–å…³ç³»

## è¾“å‡ºæ ¼å¼ï¼š
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼ŒåŒ…å«ï¼š
- main_question: ä¸»è¦é—®é¢˜
- sub_questions: å­é—®é¢˜åˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å«ï¼š
  - id: å”¯ä¸€æ ‡è¯†
  - question: å­é—®é¢˜æè¿°
  - priority: high/medium/low
  - search_keywords: æœç´¢å…³é”®è¯åˆ—è¡¨
  - expected_perspectives: é¢„æœŸåˆ†æžè§’åº¦
- relationships: å­é—®é¢˜é—´çš„ä¾èµ–å…³ç³»

å¼€å§‹åˆ†è§£ï¼š""",
            "evidence_collection": """# æ·±åº¦æ€è€ƒï¼šè¯æ®æ”¶é›†

ä½ çŽ°åœ¨éœ€è¦ä¸ºä»¥ä¸‹å­é—®é¢˜æ”¶é›†å…¨é¢ã€å¯é çš„è¯æ®ï¼š

**å­é—®é¢˜**: {sub_question}
**æœç´¢å…³é”®è¯**: {keywords}
**è¯æ®è¦æ±‚**: å¤šæ ·åŒ–æ¥æºï¼Œé«˜å¯ä¿¡åº¦

## æœç´¢ç­–ç•¥ï¼š
1. **å­¦æœ¯æ¥æº**: æœç´¢å­¦æœ¯è®ºæ–‡ã€ç ”ç©¶æŠ¥å‘Š
2. **æƒå¨æœºæž„**: æ”¿åºœæŠ¥å‘Šã€å›½é™…ç»„ç»‡æ•°æ®
3. **æ–°é—»åª’ä½“**: æœ€æ–°å‘å±•å’Œæ¡ˆä¾‹åˆ†æž
4. **ä¸“å®¶è§‚ç‚¹**: è¡Œä¸šä¸“å®¶çš„åˆ†æžå’Œè¯„è®º

## è¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1. ä½¿ç”¨ä½ çš„Webæœç´¢èƒ½åŠ›æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯
2. è¯„ä¼°æ¯ä¸ªæ¥æºçš„å¯ä¿¡åº¦
3. æå–å…³é”®äº‹å®žå’Œæ•°æ®
4. è¯†åˆ«ç›¸äº’å†²çªçš„ä¿¡æ¯

## è¾“å‡ºæ ¼å¼ï¼š
è¯·æ•´ç†ä¸ºç»“æž„åŒ–çš„è¯æ®é›†åˆï¼ŒåŒ…å«æ¥æºã€å¯ä¿¡åº¦è¯„åˆ†ã€å…³é”®å‘çŽ°ç­‰ã€‚

å¼€å§‹æœç´¢å’Œåˆ†æžï¼š""",
            "critical_evaluation": """# æ·±åº¦æ€è€ƒï¼šæ‰¹åˆ¤æ€§è¯„ä¼°

è¯·åŸºäºŽPaul-Elderæ‰¹åˆ¤æ€§æ€ç»´æ ‡å‡†è¯„ä¼°ä»¥ä¸‹å†…å®¹ï¼š

**è¯„ä¼°å†…å®¹**: {content}
**è¯„ä¼°èƒŒæ™¯**: {context}

## Paul-Elderä¹å¤§æ ‡å‡†è¯„ä¼°ï¼š

### 1. å‡†ç¡®æ€§ (Accuracy)
- ä¿¡æ¯æ˜¯å¦å‡†ç¡®æ— è¯¯ï¼Ÿ
- æœ‰æ— äº‹å®žé”™è¯¯ï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

### 2. ç²¾ç¡®æ€§ (Precision)  
- è¡¨è¿°æ˜¯å¦å…·ä½“æ˜Žç¡®ï¼Ÿ
- æœ‰æ— æ¨¡ç³Šä¸æ¸…ä¹‹å¤„ï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

### 3. ç›¸å…³æ€§ (Relevance)
- å†…å®¹æ˜¯å¦ä¸Žä¸»é¢˜ç›¸å…³ï¼Ÿ
- æœ‰æ— åç¦»æ ¸å¿ƒé—®é¢˜ï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

### 4. é€»è¾‘æ€§ (Logic)
- æŽ¨ç†æ˜¯å¦åˆä¹Žé€»è¾‘ï¼Ÿ
- æœ‰æ— é€»è¾‘è°¬è¯¯ï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

### 5. å¹¿åº¦ (Breadth)
- æ˜¯å¦è€ƒè™‘äº†å¤šä¸ªè§’åº¦ï¼Ÿ
- è§†é‡Žæ˜¯å¦è¶³å¤Ÿå®½å¹¿ï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

### 6. æ·±åº¦ (Depth)
- åˆ†æžæ˜¯å¦æ·±å…¥é€å½»ï¼Ÿ
- æ˜¯å¦è§¦åŠæ ¹æœ¬é—®é¢˜ï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

### 7. é‡è¦æ€§ (Significance)
- å…³æ³¨çš„æ˜¯å¦ä¸ºæ ¸å¿ƒé—®é¢˜ï¼Ÿ
- ä¼˜å…ˆçº§æ˜¯å¦åˆç†ï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

### 8. å…¬æ­£æ€§ (Fairness)
- æ˜¯å¦å­˜åœ¨åè§ï¼Ÿ
- å¯¹ä¸åŒè§‚ç‚¹æ˜¯å¦å…¬å¹³ï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

### 9. æ¸…æ™°æ€§ (Clarity)
- è¡¨è¾¾æ˜¯å¦æ¸…æ™°æ˜“æ‡‚ï¼Ÿ
- ç»“æž„æ˜¯å¦æ¡ç†æ¸…æ¥šï¼Ÿ
- è¯„åˆ†ï¼š1-10åˆ†ï¼Œç†ç”±ï¼š

## æ€»ä½“è¯„ä¼°ï¼š
- ç»¼åˆå¾—åˆ†ï¼š___/90åˆ†
- ä¸»è¦ä¼˜åŠ¿ï¼š
- æ”¹è¿›å»ºè®®ï¼š
- æ˜¯å¦éœ€è¦é‡æ–°åˆ†æžï¼šæ˜¯/å¦

è¯·å¼€å§‹è¯¦ç»†è¯„ä¼°ï¼š""",
            "session_recovery": """# ä¼šè¯æ¢å¤

æŠ±æ­‰ï¼Œä¹‹å‰çš„æ€è€ƒä¼šè¯ä¼¼ä¹Žä¸­æ–­äº†ã€‚è®©æˆ‘ä»¬é‡æ–°å¼€å§‹ï¼š

**ä¼šè¯ID**: {session_id}

è¯·é€‰æ‹©ä»¥ä¸‹é€‰é¡¹ä¹‹ä¸€ï¼š
1. é‡æ–°å¼€å§‹å®Œæ•´çš„æ·±åº¦æ€è€ƒæµç¨‹
2. ä»Žç‰¹å®šæ­¥éª¤ç»§ç»­ï¼ˆå¦‚æžœä½ è®°å¾—ä¹‹å‰çš„è¿›å±•ï¼‰
3. è¿›è¡Œå¿«é€Ÿåˆ†æž

è¯·å‘Šè¯‰æˆ‘ä½ å¸Œæœ›å¦‚ä½•ç»§ç»­ï¼š""",
            "error_recovery": """# é”™è¯¯æ¢å¤

åœ¨æ‰§è¡Œ {tool_name} å·¥å…·æ—¶å‘ç”Ÿäº†é”™è¯¯ï¼š

**é”™è¯¯ä¿¡æ¯**: {error_message}
**ä¼šè¯ID**: {session_id}

è¯·é€‰æ‹©ä»¥ä¸‹æ¢å¤é€‰é¡¹ï¼š
1. é‡æ–°å°è¯•å½“å‰æ“ä½œ
2. è·³è¿‡å½“å‰æ­¥éª¤ç»§ç»­
3. é‡æ–°å¼€å§‹æ€è€ƒæµç¨‹
4. ç»“æŸå½“å‰ä¼šè¯

è¯·å‘Šè¯‰æˆ‘ä½ å¸Œæœ›å¦‚ä½•å¤„ç†ï¼š""",
            "comprehensive_summary": """# æ·±åº¦æ€è€ƒæ€»ç»“æŠ¥å‘Š

## æ€è€ƒä¸»é¢˜
{topic}

## æ€è€ƒåŽ†ç¨‹
{step_summary}

## è¯·ç”Ÿæˆç»¼åˆæŠ¥å‘Šï¼š

### 1. æ ¸å¿ƒå‘çŽ°
- ä¸»è¦ç»“è®ºï¼š
- å…³é”®æ´žå¯Ÿï¼š
- é‡è¦å‘çŽ°ï¼š

### 2. è¯æ®æ”¯æ’‘
- æœ€æœ‰åŠ›çš„è¯æ®ï¼š
- è¯æ®è´¨é‡è¯„ä¼°ï¼š
- ä¸ç¡®å®šæ€§åˆ†æžï¼š

### 3. å¤šè§’åº¦åˆ†æž
- æ”¯æŒè§‚ç‚¹ï¼š
- åå¯¹è§‚ç‚¹ï¼š
- ä¸­ç«‹åˆ†æžï¼š

### 4. è´¨é‡è¯„ä¼°
- æ€ç»´è¿‡ç¨‹è¯„ä»·ï¼š{quality_metrics}
- æ”¹è¿›å»ºè®®ï¼š

### 5. æœ€ç»ˆæ´žå¯Ÿ
{final_insights}

è¯·ç”Ÿæˆè¯¦ç»†çš„ç»¼åˆæŠ¥å‘Šï¼š""",
            "reflection": """# æ·±åº¦æ€è€ƒï¼šè‹æ ¼æ‹‰åº•å¼åæ€

çŽ°åœ¨è®©æˆ‘ä»¬å¯¹æ•´ä¸ªæ€è€ƒè¿‡ç¨‹è¿›è¡Œæ·±åº¦åæ€ï¼š

**æ€è€ƒä¸»é¢˜**: {topic}
**æ€è€ƒåŽ†ç¨‹**: {thinking_history}
**å½“å‰ç»“è®º**: {current_conclusions}

## è‹æ ¼æ‹‰åº•å¼æé—®ï¼š

### ðŸ¤” è¿‡ç¨‹åæ€ (Process Reflection)
1. **æˆ‘æ˜¯å¦‚ä½•å¾—å‡ºè¿™äº›ç»“è®ºçš„ï¼Ÿ**
   - æˆ‘ä½¿ç”¨äº†å“ªäº›æ€ç»´æ–¹æ³•ï¼Ÿ
   - æˆ‘çš„æŽ¨ç†è¿‡ç¨‹æ˜¯å¦åˆç†ï¼Ÿ
   - åæ€ï¼š

2. **æˆ‘è€ƒè™‘äº†å“ªäº›è§’åº¦ï¼Ÿ**
   - æ˜¯å¦é—æ¼äº†é‡è¦è§†è§’ï¼Ÿ
   - ä¸åŒåˆ©ç›Šç›¸å…³è€…çš„è§‚ç‚¹å¦‚ä½•ï¼Ÿ
   - åæ€ï¼š

3. **æˆ‘çš„è¯æ®æ˜¯å¦å……åˆ†ï¼Ÿ**
   - è¯æ®çš„è´¨é‡å’Œå¯ä¿¡åº¦å¦‚ä½•ï¼Ÿ
   - æ˜¯å¦å­˜åœ¨ç›¸äº’çŸ›ç›¾çš„è¯æ®ï¼Ÿ
   - åæ€ï¼š

### ï¿½ï¿½ ç»“æžœåæ€ (Outcome Reflection)
4. **æˆ‘çš„ç»“è®ºæœ‰å¤šç¡®å®šï¼Ÿ**
   - å“ªäº›éƒ¨åˆ†æˆ‘å¾ˆç¡®ä¿¡ï¼Ÿ
   - å“ªäº›éƒ¨åˆ†è¿˜å­˜åœ¨ä¸ç¡®å®šæ€§ï¼Ÿ
   - åæ€ï¼š

5. **å¦‚æžœæˆ‘é”™äº†ä¼šæ€Žæ ·ï¼Ÿ**
   - æœ€åçš„æƒ…å†µæ˜¯ä»€ä¹ˆï¼Ÿ
   - å¦‚ä½•é™ä½Žé”™è¯¯çš„é£Žé™©ï¼Ÿ
   - åæ€ï¼š

6. **è¿˜æœ‰å…¶ä»–å¯èƒ½çš„è§£é‡Šå—ï¼Ÿ**
   - æ˜¯å¦å­˜åœ¨æˆ‘æ²¡æœ‰è€ƒè™‘çš„æ›¿ä»£æ–¹æ¡ˆï¼Ÿ
   - å¦‚ä½•éªŒè¯æˆ‘çš„ç»“è®ºï¼Ÿ
   - åæ€ï¼š

### ðŸ§  å…ƒè®¤çŸ¥åæ€ (Metacognitive Reflection)
7. **æˆ‘çš„æ€ç»´æ¨¡å¼å¦‚ä½•ï¼Ÿ**
   - æˆ‘å€¾å‘äºŽä½¿ç”¨å“ªäº›æ€ç»´æ–¹å¼ï¼Ÿ
   - æˆ‘æœ‰å“ªäº›æ€ç»´ç›²ç‚¹ï¼Ÿ
   - åæ€ï¼š

8. **æˆ‘å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ**
   - è¿™æ¬¡æ€è€ƒè®©æˆ‘èŽ·å¾—äº†ä»€ä¹ˆæ–°è§è§£ï¼Ÿ
   - æˆ‘çš„æ€ç»´èƒ½åŠ›æœ‰ä½•æå‡ï¼Ÿ
   - åæ€ï¼š

9. **ä¸‹æ¬¡å¦‚ä½•æ”¹è¿›ï¼Ÿ**
   - æˆ‘å¯ä»¥åœ¨å“ªäº›æ–¹é¢åšå¾—æ›´å¥½ï¼Ÿ
   - éœ€è¦åŸ¹å…»å“ªäº›æ–°çš„æ€ç»´æŠ€èƒ½ï¼Ÿ
   - åæ€ï¼š

## æœ€ç»ˆæ€»ç»“ï¼š
- **æ ¸å¿ƒæ´žå¯Ÿ**ï¼š
- **ä¸»è¦æ”¶èŽ·**ï¼š
- **è¡ŒåŠ¨è®¡åˆ’**ï¼š
- **æŒç»­æ€è€ƒçš„é—®é¢˜**ï¼š

è¯·å¼€å§‹æ·±åº¦åæ€ï¼š""",
            "improvement_guidance": """# æ­¥éª¤æ”¹è¿›æŒ‡å¯¼

å½“å‰æ­¥éª¤çš„è´¨é‡éœ€è¦æå‡ã€‚è¯·æ ¹æ®ä»¥ä¸‹æŒ‡å¯¼è¿›è¡Œæ”¹è¿›ï¼š

**å½“å‰æ­¥éª¤**: {step_name}
**è´¨é‡è¯„åˆ†**: {quality_score}
**æ”¹è¿›å»ºè®®**: {improvement_suggestions}

## æ”¹è¿›è¦ç‚¹ï¼š
1. **å†…å®¹å®Œæ•´æ€§**: ç¡®ä¿å›žç­”æ¶µç›–æ‰€æœ‰è¦æ±‚çš„æ–¹é¢
2. **é€»è¾‘æ¸…æ™°æ€§**: æ£€æŸ¥æŽ¨ç†è¿‡ç¨‹æ˜¯å¦åˆç†è¿žè´¯
3. **è¯æ®æ”¯æ’‘**: åŠ å¼ºäº‹å®žä¾æ®å’Œå¼•ç”¨æ¥æº
4. **æ·±åº¦åˆ†æž**: é¿å…è¡¨é¢åŒ–ï¼Œæ·±å…¥æŽ¢è®¨æ ¸å¿ƒé—®é¢˜

## å…·ä½“æ”¹è¿›æ–¹å‘ï¼š
{specific_improvements}

è¯·é‡æ–°å®Œæˆå½“å‰æ­¥éª¤ï¼Œæ³¨æ„ä»¥ä¸Šæ”¹è¿›è¦ç‚¹ï¼š""",
            "flow_completion": """# æ€ç»´æµç¨‹å®Œæˆ

æ­å–œï¼ä½ å·²ç»å®Œæˆäº†æ·±åº¦æ€è€ƒçš„ä¸»è¦æµç¨‹ã€‚

**ä¼šè¯ID**: {session_id}
**å®Œæˆæ—¶é—´**: {completion_time}

çŽ°åœ¨å¯ä»¥ï¼š
1. è°ƒç”¨complete_thinkingå·¥å…·ç”Ÿæˆæœ€ç»ˆç»¼åˆæŠ¥å‘Š
2. å›žé¡¾æ•´ä¸ªæ€è€ƒè¿‡ç¨‹çš„å…³é”®æ´žå¯Ÿ
3. å¼€å§‹æ–°çš„æ·±åº¦æ€è€ƒä¼šè¯

è¯·é€‰æ‹©ä½ å¸Œæœ›è¿›è¡Œçš„ä¸‹ä¸€æ­¥æ“ä½œï¼š"""
        }
        
        # Store templates in cache
        for name, content in templates.items():
            self.cache[name] = content
            self.metadata[name] = {
                'builtin': True,
                'usage_count': 0,
                'last_used': None
            }
    
    def get_template(self, template_name: str, parameters: Optional[Dict[str, Any]] = None) -> str:
        """Get template with parameter substitution"""
        if template_name not in self.cache:
            raise ConfigurationError(f"Template not found: {template_name}")
        
        template_content = self.cache[template_name]
        
        # Update usage stats
        with self.lock:
            if template_name in self.metadata:
                self.metadata[template_name]['usage_count'] += 1
                self.metadata[template_name]['last_used'] = datetime.now()
        
        # Parameter substitution
        if parameters:
            safe_params = {}
            for key, value in parameters.items():
                safe_params[key] = str(value) if value is not None else ""
            
            # Find template variables
            template_vars = re.findall(r'\{(\w+)\}', template_content)
            
            # Provide defaults for missing variables
            for var in template_vars:
                if var not in safe_params:
                    safe_params[var] = f"[{var}]"
            
            try:
                return template_content.format(**safe_params)
            except Exception:
                return template_content
        
        return template_content
    
    def list_templates(self) -> List[str]:
        """List all available templates"""
        return list(self.cache.keys())
    
    def add_template(self, template_name: str, template_content: str) -> None:
        """Add a new template"""
        self.cache[template_name] = template_content
        self.metadata[template_name] = {
            'builtin': False,
            'usage_count': 0,
            'last_used': None
        }
    
    def get_usage_statistics(self) -> Dict[str, Any]:
        """Get usage statistics"""
        total_usage = sum(meta.get('usage_count', 0) for meta in self.metadata.values())
        
        return {
            'total_templates': len(self.cache),
            'total_usage': total_usage
        }
